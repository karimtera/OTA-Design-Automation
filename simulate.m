function sim=simulate(M,spec)
% this function simulates a given model of 5T OTA
% using spectre simulator

%% Simulation

c.modelfile = '"/home/cadence/Desktop/Project/web_matlab/lib/ptm_180nm_bsim3.txt"';
c.modelinfo = 'PTM 180nm CMOS, BSIM3v3';
c.corner = 'NOM';
c.temp = 300;
c.simcmd = '/usr/local/cadence/MMSIM141/bin/spectre -64 ota_5t_tb.scs';
%% Determining the transistors types

if spec.CMIR_HIGH + spec.CMIR_LOW >= spec.VDD
    input_pair_type = 'nch';
    current_mirror_load_type = 'pch';
    tail_current_source_type = 'nch';
    connect_vdd_to = '0';
    connect_ground_to = 'vdd!';
    idc_from = 'vdd!'; 
    idc_to = 'net012';
else
    input_pair_type = 'pch';
    current_mirror_load_type = 'nch';
    tail_current_source_type = 'pch';
    connect_vdd_to = 'vdd!';
    connect_ground_to = '0';
    idc_from = 'net012';
    idc_to = '0';
end
%% Simulation netlist

netlist = sprintf([...
'// Generated for: spectre\n'...
'// Generated on: Jul 30 08:16:04 2018\n'...
'// Design library name: test\n'...
'// Design cell name: tstbench\n'...
'// Design view name: schematic\n'...
'simulator lang=spectre\n'...
'global 0 vdd!\n'...
'parameters W6=%0.2fe-6 L6=%0.2fe-6 L5=%0.2fe-6 W5=%0.2fe-6 L2=%0.2fe-6 \\\\\n'...
'    W2=%0.2fe-6 L1=%0.2fe-6 W1=%0.2fe-6 W4=%0.2fe-6 L4=%0.2fe-6 L3=%0.2fe-6 \\\\\n'...
'    W3=%0.2fe-6 IB=%d CL=%d VDD=%0.2f VICM=%0.2f\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=dio3\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=dio_dnw\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=dio\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfres_sa\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfmvar\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfind\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rtmom\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_bbmvar\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfesd\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_mim\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfrtmom\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfres_hri\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfres_rpo\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_3vna\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_m\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfmos\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfmim\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfjvar\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_3m\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_res\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_bip3\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_bip\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_3v\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfmos33\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_na\n'...
'include "/home/cadence/my_project/tsmc18rf_1.8v/tsmc18rf/tsmc18rf/../models/spectre/rf018.scs" section=tt_rfsbd\n'...
'\n'...
'// Library name: test\n'...
'// Cell name: tstfd\n'...
'// View name: schematic\n'...
'subckt tstfd IBIAS VDD VINN VINP VOUT ground\n'...
'    M5 (net011 IBIAS VDD VDD) %s l=L5 w=W5 m=1 \\\\\n'...
'        ad=(W5*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*int(1/2))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        as=(W5*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        pd=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2))))*(int((1+2)/2)-int((1+1)/2))))*W5+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*int(1/2))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        ps=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0-0))*(int((1+2)/2)-int((1+1)/2))))*W5+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        nrd=(5.4e-07+2.7e-07*(1*2-2))/1/(W5*2) \\\\\n'...
'        nrs=(5.4e-07+2.7e-07*(1*2-2))/1/(W5*2)\n'...
'    M6 (IBIAS IBIAS VDD VDD) %s l=L6 w=W6 m=1 \\\\\n'...
'        ad=(W6*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*int(1/2))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        as=(W6*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        pd=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2))))*(int((1+2)/2)-int((1+1)/2))))*W6+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*int(1/2))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        ps=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0-0))*(int((1+2)/2)-int((1+1)/2))))*W6+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        nrd=(5.4e-07+2.7e-07*(1*2-2))/1/(W6*2) \\\\\n'...
'        nrs=(5.4e-07+2.7e-07*(1*2-2))/1/(W6*2)\n'...
'    M2 (VOUT VINN net011 net011) %s l=L2 w=W2 m=1 \\\\\n'...
'        ad=(W2*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*int(1/2))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        as=(W2*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        pd=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2))))*(int((1+2)/2)-int((1+1)/2))))*W2+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*int(1/2))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        ps=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0-0))*(int((1+2)/2)-int((1+1)/2))))*W2+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        nrd=(5.4e-07+2.7e-07*(1*2-2))/1/(W2*2) \\\\\n'...
'        nrs=(5.4e-07+2.7e-07*(1*2-2))/1/(W2*2)\n'...
'    M1 (net5 VINP net011 net011) %s l=L1 w=W1 m=1 \\\\\n'...
'        ad=(W1*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*int(1/2))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        as=(W1*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        pd=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2))))*(int((1+2)/2)-int((1+1)/2))))*W1+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*int(1/2))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        ps=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0-0))*(int((1+2)/2)-int((1+1)/2))))*W1+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        nrd=(5.4e-07+2.7e-07*(1*2-2))/1/(W1*2) \\\\\n'...
'        nrs=(5.4e-07+2.7e-07*(1*2-2))/1/(W1*2)\n'...
'    M4 (VOUT net5 ground ground) %s l=L4 w=W4 m=1 \\\\\n'...
'        ad=(W4*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*int(1/2))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        as=(W4*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        pd=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2))))*(int((1+2)/2)-int((1+1)/2))))*W4+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*int(1/2))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        ps=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0-0))*(int((1+2)/2)-int((1+1)/2))))*W4+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        nrd=(5.4e-07+2.7e-07*(1*2-2))/1/(W4*2) \\\\\n'...
'        nrs=(5.4e-07+2.7e-07*(1*2-2))/1/(W4*2)\n'...
'    M3 (net5 net5 ground ground) %s l=L3 w=W3 m=1 \\\\\n'...
'        ad=(W3*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*int(1/2))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        as=(W3*((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))+((0*0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2))))/1 \\\\\n'...
'        pd=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(1/2)*5.4e-07*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*((1+1)*(int((1+1)/2)-int(1/2))+(1+0)*(int((1+2)/2)-int((1+1)/2))))*(int((1+2)/2)-int((1+1)/2))))*W3+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*int(1/2))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        ps=(((4.8e-07+((1-1)*5.4e-07)/2+0)*(int((1+1)/2)-int(1/2))+(4.8e-07+4.8e-07+(int(1/2)-1)*5.4e-07+0+0)*(int((1+2)/2)-int((1+1)/2)))*2+(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-((0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0))*(int((1+1)/2)-int(1/2))+(0*(((1+1)*(int((1+1)/2)-int(1/2))+(1+2)*(int((1+2)/2)-int((1+1)/2)))-0-0))*(int((1+2)/2)-int((1+1)/2))))*W3+((0*((1-1)/2+1-0))*(int((1+1)/2)-int(1/2))+(0*(int(1/2)+1-0-0))*(int((1+2)/2)-int((1+1)/2)))*4)/1 \\\\\n'...
'        nrd=(5.4e-07+2.7e-07*(1*2-2))/1/(W3*2) \\\\\n'...
'        nrs=(5.4e-07+2.7e-07*(1*2-2))/1/(W3*2)\n'...
'ends tstfd\n'...
'// End of subcircuit definition.\n'...
'\n'...
'// Library name: test\n'...
'// Cell name: tstbench\n'...
'// View name: schematic\n'...
'I0 (net012 %s net02 net06 vout %s) tstfd\n'...
'IPRB0 (net02 vout) iprobe\n'...
'V3 (net06 0) vsource dc=VICM mag=1 type=dc\n'...
'V0 (vdd! 0) vsource dc=VDD type=dc\n'...
'C0 (vout 0) capacitor c=CL\n'...
'I7 (%s %s) isource dc=IB type=dc\n'...
'simulatorOptions options reltol=1e-3 vabstol=1e-6 iabstol=1e-12 temp=27 \\\\\n'...
'    tnom=27 scalem=1.0 scale=1.0 gmin=1e-12 rforce=1 maxnotes=5 maxwarns=5 \\\\\n'...
'    digits=5 cols=80 pivrel=1e-3 sensfile="../psf/sens.output" \\\\\n'...
'    checklimitdest=psf \n'...
'dcOp dc write="spectre.dc" maxiters=150 maxsteps=10000 annotate=status\n'...
'dcOpInfo info what=oppoint where=rawfile\n'...
'ac ac start=10 stop=10G dec=10 annotate=status \n'...
'stb stb start=10 stop=10G dec=10 probe=IPRB0 annotate=status \n'...
'modelParameter info what=models where=rawfile\n'...
'element info what=inst where=rawfile\n'...
'outputParameter info what=output where=rawfile\n'...
'designParamVals info what=parameters where=rawfile\n'...
'primitives info what=primitives where=rawfile\n'...
'subckts info what=subckts where=rawfile\n'...
'save vout \n'...
'saveOptions options save=allpub\n'...
...
],M(6).W,M(6).L,M(5).L,M(5).W,M(2).L,M(2).W,M(1).L,M(1).W,M(4).W,M(4).L,M(3).L,M(3).W,spec.IBIAS/2,spec.CL,spec.VDD,spec.VICM...
,tail_current_source_type...
,tail_current_source_type...
,input_pair_type,input_pair_type...
,current_mirror_load_type...
,current_mirror_load_type...
,connect_vdd_to,connect_ground_to...
,idc_from,idc_to);

% Write netlist
fid = fopen('ota_5t_tb.scs', 'w');
fprintf(fid, netlist);
fclose(fid);

% pause for 1 second
pause(1)
        
% Run simulator
[status,result] = system(c.simcmd);
if(status)
    disp('Simulation did not run properly.')
    return;
end 

sim.LG = cds_srr('ota_5t_tb.raw','stb-stb','loopGain');
% sim.MAGED = cds_srr('ota_5t_tb.raw','stb-stb','vout','gainBwProd');
sim.LGmag = abs(sim.LG.LOOPGAIN);
sim.LGmagdB = 20*log10(sim.LGmag);
sim.freq = sim.LG.freq;
sim.Ao = sim.LGmag(1);
sim.AodB = sim.LGmagdB(1);
sim.BW = interp1(sim.LGmagdB, sim.freq, sim.AodB - 3);
sim.GBW = sim.Ao * sim.BW;
sim.UGF = cds_srr('ota_5t_tb.raw','stb-margin.stb','phaseMarginFreq');
sim.PM = cds_srr('ota_5t_tb.raw','stb-margin.stb','phaseMargin');
sim.GM = (cds_srr('ota_5t_tb.raw','dcOpInfo-info','I0.M1:gm') + cds_srr('ota_5t_tb.raw','dcOpInfo-info','I0.M2:gm')) / 2;
sim.CLeffLG = sim.GM / 2 / pi / sim.GBW;
sim.VOUT = cds_srr('ota_5t_tb.raw','ac-ac','vout');
sim.VOUTmag = abs(sim.VOUT.V);
sim.AoCL = sim.VOUTmag(1);
sim.BWCL = interp1(sim.VOUTmag,sim.VOUT.freq,sim.AoCL/sqrt(2));
sim.GBWCL = sim.AoCL * sim.BWCL;
sim.CLeffCL = sim.GM / 2 / pi / sim.GBWCL;
sim.IIN = cds_srr('ota_5t_tb.raw','ac-ac','V3:p');
sim.CIN = abs(imag(sim.IIN.I)) / 2 / pi ./ sim.IIN.freq;
sim.CINo = sim.CIN(1);
% sim
Msim(1).CGS = abs(cds_srr('ota_5t_tb.raw','dcOpInfo-info','I0.M1:cgs'));
Msim(1).CGD = abs(cds_srr('ota_5t_tb.raw','dcOpInfo-info','I0.M1:cgd'));
Msim(1).CGS * 3/4 / sim.Ao + Msim(1).CGD;



